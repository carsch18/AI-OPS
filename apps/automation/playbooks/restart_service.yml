---
# Restart Service Playbook
# Safe restart with pre/post health checks

- name: Restart Service
  hosts: "{{ target_host | default('localhost') }}"
  gather_facts: true
  vars:
    service_name: "{{ service | default('nginx') }}"
    callback_url: "{{ callback | default('http://localhost:8000/automation/callback') }}"
    action_id: "{{ action_id | default('unknown') }}"

  tasks:
    - name: Report start
      uri:
        url: "{{ callback_url }}"
        method: POST
        body_format: json
        body:
          action_id: "{{ action_id }}"
          status: "running"
          message: "Starting service restart for {{ service_name }}"
      ignore_errors: true

    - name: Check if service exists
      command: "systemctl status {{ service_name }}"
      register: service_status
      ignore_errors: true
      changed_when: false

    - name: Service does not exist
      fail:
        msg: "Service {{ service_name }} not found on this host"
      when: service_status.rc == 4

    - name: Get service PID before restart
      command: "pgrep -f {{ service_name }}"
      register: pid_before
      ignore_errors: true
      changed_when: false

    - name: Restart the service
      service:
        name: "{{ service_name }}"
        state: restarted
      become: true
      register: restart_result

    - name: Wait for service to stabilize
      wait_for:
        timeout: 5

    - name: Verify service is running
      command: "systemctl is-active {{ service_name }}"
      register: service_active
      changed_when: false

    - name: Report success
      uri:
        url: "{{ callback_url }}"
        method: POST
        body_format: json
        body:
          action_id: "{{ action_id }}"
          status: "completed"
          success: true
          message: "Service {{ service_name }} restarted successfully"
          details:
            service: "{{ service_name }}"
            status: "{{ service_active.stdout }}"
      when: service_active.stdout == "active"

    - name: Report failure
      uri:
        url: "{{ callback_url }}"
        method: POST
        body_format: json
        body:
          action_id: "{{ action_id }}"
          status: "failed"
          success: false
          message: "Service {{ service_name }} failed to restart"
          details:
            service: "{{ service_name }}"
            status: "{{ service_active.stdout | default('unknown') }}"
      when: service_active.stdout != "active"
      ignore_errors: true
